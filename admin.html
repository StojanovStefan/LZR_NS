<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Panel</title>

    <style>
      body {
        font-family: Arial;
        background: #e5e7eb;
        color: black;
        padding: 20px;
      }
      .teamContainer {
        display: flex;
        gap: 30px;
      }
      .teamBox {
        width: 48%;
        background: #d1d5db;
        padding: 20px;
        border-radius: 10px;
      }
      #teamA_name,
      #teamB_name {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .teamLogo {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 50%;
      }
      h2 {
        margin-top: 0;
      }
      .playerBox {
        background: #8b8f96;
        color: #ececec;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        cursor: pointer;
      }
      .playerBox:hover {
        background: #8b8f96;
        color: #1f2937;
      }
      .actions {
        margin-top: 5px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }
      .actionBtn {
        padding: 5px 8px;
        border: none;
        border-radius: 5px;
        background: #4b5563;
        color: white;
        cursor: pointer;
      }
      .actionBtn:hover {
        background: #fbbf24;
        color: black;
      }
      #undoBtn {
        display: block;
        margin: 50px auto;
        padding: 12px 25px;
        background: #4b5563;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease-in-out;
        width: 200px;
        text-align: center;
      }

      #undoBtn:hover {
        background: #fbbf24;
        color: black;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.25);
      }

      #finishBtn {
        display: block;
        margin: 170px auto;
        padding: 12px 25px;
        background: #4b5563;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease-in-out;
        width: 200px;
        text-align: center;
      }
      #finishBtn:hover {
        background: #fbbf24;
        color: black;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.25);
      }
    </style>
  </head>

  <body>
    <h1>Admin Panel</h1>

    <div class="teamContainer">
      <div class="teamBox" id="teamA_box">
        <h2 id="teamA_name"></h2>
        <div id="teamA_players"></div>
      </div>

      <div class="teamBox" id="teamB_box">
        <h2 id="teamB_name"></h2>
        <div id="teamB_players"></div>
      </div>
    </div>

    <button id="undoBtn">Undo Last Play</button>

    <button id="finishBtn">Finish Game</button>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
        update,
        increment,
        push,
        get,
        remove,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBrMu0mjZw1SIh-0KgEVaKoPURdN1PhC0w",
        authDomain: "kk-panthers-39d91.firebaseapp.com",
        databaseURL:
          "https://kk-panthers-39d91-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "kk-panthers-39d91",
        storageBucket: "kk-panthers-39d91.appspot.com",
        messagingSenderId: "605710897252",
        appId: "1:605710897252:web:9469a8022065af45748f71",
        measurementId: "G-KL6BJPX04S",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      const gameId = getQueryParam("id");
      if (!gameId) {
        document.body.innerHTML = "<p>No game selected.</p>";
        throw new Error("No game ID provided in URL");
      }

      let teamA = "";
      let teamB = "";

      onValue(ref(db, `games/${gameId}/gameInfo`), (snap) => {
        const info = snap.val();
        if (!info) return;

        teamA = info.teamA;
        teamB = info.teamB;

        document.getElementById(
          "teamA_name"
        ).innerHTML = `<img src="team_logo/${info.teamA_logo}" class="teamLogo"><span>${teamA}</span>`;

        document.getElementById(
          "teamB_name"
        ).innerHTML = `<img src="team_logo/${info.teamB_logo}" class="teamLogo"><span>${teamB}</span>`;

        loadPlayers();
      });

      function loadPlayers() {
        if (teamA) loadTeamPlayers(teamA, "teamA_players");
        if (teamB) loadTeamPlayers(teamB, "teamB_players");
      }

      function loadTeamPlayers(team, boxId) {
        onValue(ref(db, `games/${gameId}/teams/${team}/players`), (snap) => {
          const players = snap.val() || {};
          const box = document.getElementById(boxId);
          box.innerHTML = "";

          for (let number in players) {
            const p = players[number];
            const div = document.createElement("div");
            div.className = "playerBox";
            div.innerHTML = `<strong>${p.name}</strong> (#${p.number})`;

            const actionsDiv = document.createElement("div");
            actionsDiv.className = "actions";

            const actions = [
              { label: "2 Miss", value: "miss_2" },
              { label: "2 Made", value: "points_2" },
              { label: "3 Miss", value: "miss_3" },
              { label: "3 Made", value: "points_3" },
              { label: "1 Miss", value: "miss_1" },
              { label: "1 Made", value: "points_1" },
              { label: "Assist", value: "assists" },
              { label: "Off Reb", value: "rebounds_off" },
              { label: "Def Reb", value: "rebounds_def" },
              { label: "Steal", value: "steals" },
              { label: "TO", value: "turnovers" },
              { label: "Block", value: "blocks" },
            ];

            actions.forEach((a) => {
              const btn = document.createElement("button");
              btn.className = "actionBtn";
              btn.textContent = a.label;
              btn.onclick = () => applyAction(team, number, a.value, p.name);
              actionsDiv.appendChild(btn);
            });

            div.appendChild(actionsDiv);
            box.appendChild(div);
          }
        });
      }

      async function applyAction(team, player, action, playerName = "") {
        const playerStatsRef = ref(
          db,
          `games/${gameId}/teams/${team}/players/${player}/stats`
        );
        const teamStatsRef = ref(
          db,
          `games/${gameId}/teams/${team}/team_stats`
        );
        const gameInfoRef = ref(db, `games/${gameId}/gameInfo`);

        let playerUpdates = {};
        let teamUpdates = {};
        let gameUpdates = {};

        function made(pts) {
          playerUpdates.points = increment(pts);
          teamUpdates.points = increment(pts);

          if (pts === 1) {
            playerUpdates.ft_made = increment(1);
            playerUpdates.ft_attempts = increment(1);
            teamUpdates.ft_made = increment(1);
            teamUpdates.ft_attempts = increment(1);
          } else if (pts === 2) {
            playerUpdates.two_made = increment(1);
            playerUpdates.two_attempts = increment(1);
            playerUpdates.fg_made = increment(1);
            playerUpdates.fg_attempts = increment(1);
            teamUpdates.two_made = increment(1);
            teamUpdates.two_attempts = increment(1);
            teamUpdates.fg_made = increment(1);
            teamUpdates.fg_attempts = increment(1);
          } else if (pts === 3) {
            playerUpdates.three_made = increment(1);
            playerUpdates.three_attempts = increment(1);
            playerUpdates.fg_made = increment(1);
            playerUpdates.fg_attempts = increment(1);
            teamUpdates.three_made = increment(1);
            teamUpdates.three_attempts = increment(1);
            teamUpdates.fg_made = increment(1);
            teamUpdates.fg_attempts = increment(1);
          }

          if (team === teamA) gameUpdates.scoreA = increment(pts);
          else gameUpdates.scoreB = increment(pts);
        }

        if (action.startsWith("points_")) {
          const pts = parseInt(action.split("_")[1]);
          made(pts);

          const lastScoreRef = ref(db, `games/${gameId}/lastScore`);
          await update(lastScoreRef, {
            player,
            playerName,
            team,
            points: pts,
            shotType: pts === 1 ? "FT" : pts === 2 ? "2PT" : "3PT",
            timestamp: Date.now(),
          });
        } else if (action.startsWith("miss_")) {
          const m = parseInt(action.split("_")[1]);
          if (m === 1) {
            playerUpdates.ft_attempts = increment(1);
            teamUpdates.ft_attempts = increment(1);
          } else if (m === 2) {
            playerUpdates.two_attempts = increment(1);
            playerUpdates.fg_attempts = increment(1);
            teamUpdates.two_attempts = increment(1);
            teamUpdates.fg_attempts = increment(1);
          } else if (m === 3) {
            playerUpdates.three_attempts = increment(1);
            playerUpdates.fg_attempts = increment(1);
            teamUpdates.three_attempts = increment(1);
            teamUpdates.fg_attempts = increment(1);
          }
        } else if (action === "assists") {
          playerUpdates.assists = increment(1);
          teamUpdates.assists = increment(1);
        } else if (action === "rebounds_off") {
          playerUpdates.rebounds_off = increment(1);
          teamUpdates.rebounds_off = increment(1);
        } else if (action === "rebounds_def") {
          playerUpdates.rebounds_def = increment(1);
          teamUpdates.rebounds_def = increment(1);
        } else if (action === "steals") {
          playerUpdates.steals = increment(1);
          teamUpdates.steals = increment(1);
        } else if (action === "turnovers") {
          playerUpdates.turnovers = increment(1);
          teamUpdates.turnovers = increment(1);
        } else if (action === "blocks") {
          playerUpdates.blocks = increment(1);
          teamUpdates.blocks = increment(1);
        }

        if (Object.keys(playerUpdates).length)
          await update(playerStatsRef, playerUpdates);
        if (Object.keys(teamUpdates).length)
          await update(teamStatsRef, teamUpdates);
        if (Object.keys(gameUpdates).length)
          await update(gameInfoRef, gameUpdates);

        await push(ref(db, `games/${gameId}/events`), {
          player,
          playerName,
          team,
          type: action,
          timestamp: Date.now(),
        });
      }

      function showNotification(message) {
        const notification = document.createElement("div");
        notification.textContent = message;

        notification.style.position = "fixed";
        notification.style.bottom = "90px";
        notification.style.left = "30px";
        notification.style.background = "#fbbf24";
        notification.style.color = "black";
        notification.style.padding = "12px 20px";
        notification.style.borderRadius = "8px";
        notification.style.fontSize = "16px";
        notification.style.boxShadow = "0 4px 8px rgba(0,0,0,0.25)";
        notification.style.opacity = "0";
        notification.style.transition = "opacity 0.3s ease";
        notification.style.zIndex = "9999";

        document.body.appendChild(notification);

        requestAnimationFrame(() => {
          notification.style.opacity = "1";
        });

        setTimeout(() => {
          notification.style.opacity = "0";
          notification.addEventListener("transitionend", () => {
            notification.remove();
          });
        }, 5000);
      }

      async function undoLastPlay() {
        const eventsSnap = await get(ref(db, `games/${gameId}/events`));
        const events = eventsSnap.val();
        if (!events) {
          return showNotification("Nema poslednjih akcija");
        }

        let lastKey = null;
        let lastTimestamp = 0;
        for (const key in events) {
          if (events[key].timestamp > lastTimestamp) {
            lastTimestamp = events[key].timestamp;
            lastKey = key;
          }
        }
        if (!lastKey) {
          return showNotification("Nema poslednjih akcija");
        }

        const lastEvent = events[lastKey];
        const { player, playerName, team, type } = lastEvent;
        const playerStatsRef = ref(
          db,
          `games/${gameId}/teams/${team}/players/${player}/stats`
        );
        const teamStatsRef = ref(
          db,
          `games/${gameId}/teams/${team}/team_stats`
        );
        const gameInfoRef = ref(db, `games/${gameId}/gameInfo`);

        let playerUpdates = {};
        let teamUpdates = {};
        let gameUpdates = {};

        if (type.startsWith("points_")) {
          const pts = parseInt(type.split("_")[1]);
          playerUpdates.points = increment(-pts);
          teamUpdates.points = increment(-pts);
          if (pts === 1) {
            playerUpdates.ft_made = increment(-1);
            playerUpdates.ft_attempts = increment(-1);
            teamUpdates.ft_made = increment(-1);
            teamUpdates.ft_attempts = increment(-1);
          }
          if (pts === 2) {
            playerUpdates.two_made = increment(-1);
            playerUpdates.two_attempts = increment(-1);
            playerUpdates.fg_made = increment(-1);
            playerUpdates.fg_attempts = increment(-1);
            teamUpdates.two_made = increment(-1);
            teamUpdates.two_attempts = increment(-1);
            teamUpdates.fg_made = increment(-1);
            teamUpdates.fg_attempts = increment(-1);
          }
          if (pts === 3) {
            playerUpdates.three_made = increment(-1);
            playerUpdates.three_attempts = increment(-1);
            playerUpdates.fg_made = increment(-1);
            playerUpdates.fg_attempts = increment(-1);
            teamUpdates.three_made = increment(-1);
            teamUpdates.three_attempts = increment(-1);
            teamUpdates.fg_made = increment(-1);
            teamUpdates.fg_attempts = increment(-1);
          }
          if (team === teamA) gameUpdates.scoreA = increment(-pts);
          else gameUpdates.scoreB = increment(-pts);
        } else if (type.startsWith("miss_")) {
          const m = parseInt(type.split("_")[1]);
          if (m === 1) {
            playerUpdates.ft_attempts = increment(-1);
            teamUpdates.ft_attempts = increment(-1);
          }
          if (m === 2) {
            playerUpdates.two_attempts = increment(-1);
            playerUpdates.fg_attempts = increment(-1);
            teamUpdates.two_attempts = increment(-1);
            teamUpdates.fg_attempts = increment(-1);
          }
          if (m === 3) {
            playerUpdates.three_attempts = increment(-1);
            playerUpdates.fg_attempts = increment(-1);
            teamUpdates.three_attempts = increment(-1);
            teamUpdates.fg_attempts = increment(-1);
          }
        } else if (type === "assists") {
          playerUpdates.assists = increment(-1);
          teamUpdates.assists = increment(-1);
        } else if (type === "rebounds_off") {
          playerUpdates.rebounds_off = increment(-1);
          teamUpdates.rebounds_off = increment(-1);
        } else if (type === "rebounds_def") {
          playerUpdates.rebounds_def = increment(-1);
          teamUpdates.rebounds_def = increment(-1);
        } else if (type === "steals") {
          playerUpdates.steals = increment(-1);
          teamUpdates.steals = increment(-1);
        } else if (type === "turnovers") {
          playerUpdates.turnovers = increment(-1);
          teamUpdates.turnovers = increment(-1);
        } else if (type === "blocks") {
          playerUpdates.blocks = increment(-1);
          teamUpdates.blocks = increment(-1);
        }

        if (Object.keys(playerUpdates).length)
          await update(playerStatsRef, playerUpdates);
        if (Object.keys(teamUpdates).length)
          await update(teamStatsRef, teamUpdates);
        if (Object.keys(gameUpdates).length)
          await update(gameInfoRef, gameUpdates);

        await remove(ref(db, `games/${gameId}/events/${lastKey}`));

        let actionText = "";
        switch (type) {
          case "points_2":
            actionText = "pogađa šut za dva poena";
            break;
          case "miss_2":
            actionText = "promašuje šut za dva poena";
            break;
          case "points_3":
            actionText = " pogađa šut za tri poena";
            break;
          case "miss_3":
            actionText = "promašuje šut za tri poena";
            break;
          case "points_1":
            actionText = "pogađa šut za jedan poen";
            break;
          case "miss_1":
            actionText = "promašuje šut za jedan poen";
            break;
          case "assists":
            actionText = "Asistira";
            break;
          case "rebounds_def":
            actionText = "Skok u odbrani";
            break;
          case "rebounds_off":
            actionText = "Skok u napadu";
            break;
          case "steals":
            actionText = "osvaja loptu";
            break;
          case "turnovers":
            actionText = "gubi loptu";
            break;
          case "blocks":
            actionText = "Blokada";
            break;
          default:
            actionText = type;
        }

        showNotification(
          `Poslednja akcija poništena: ${playerName} - ${actionText}`
        );
      }

      document
        .getElementById("undoBtn")
        .addEventListener("click", undoLastPlay);

      async function finishGame() {
        const gameInfoRef = ref(db, `games/${gameId}/gameInfo`);

        await update(gameInfoRef, { status: "finished" });

        showNotification("Utakmica je uspešno završena!");
      }

      document
        .getElementById("finishBtn")
        .addEventListener("click", finishGame);
    </script>
  </body>
</html>
